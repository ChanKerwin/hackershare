# frozen_string_literal: true

require "open-uri"

class RemoteFetchJob < ApplicationJob
  queue_as :default

  def perform(bookmark_id)
    bookmark = Bookmark.find(bookmark_id)
    parser = LinkThumbnailer.generate(bookmark.url)
    favicon_url = parser.favicon
    begin
      open(parser.favicon, open_timeout: 3)
    rescue OpenURI::HTTPError, Errno::ENOENT
      url_parser = URI.parse(bookmark.url)
      favicon_url = [url_parser.scheme, "://", url_parser.host, "/favicon.ico"].join
      begin
        open(favicon_url, open_timeout: 3)
      rescue OpenURI::HTTPError, Errno::ENOENT
        favicon_url = nil
      end
    end
    lang = parser.title.each_char.any? { |char| char.ord.in?(0x4E00..0x9FFF) } ? :chinese : :english
    bookmark.update(favicon: favicon_url, description: parser.description, title: parser.title, lang: lang)
    bookmark.save_favicon if bookmark.favicon.present?
  rescue LinkThumbnailer::HTTPError
    # TODO
  end
end
